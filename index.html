<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestion des invités optimisée avec recherche</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
input, select { margin: 5px; padding: 5px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
button { padding: 5px 10px; margin: 5px; }
#pagination button { margin: 2px; }
</style>
</head>
<body>

<div id="loginDiv">
<h2>Connexion</h2>
<input type="text" id="username" placeholder="Nom utilisateur">
<input type="password" id="password" placeholder="Mot de passe">
<select id="role">
<option value="user">Utilisateur</option>
<option value="admin">Admin</option>
</select>
<button onclick="login()">Se connecter</button>
</div>

<div id="mainDiv" class="hidden">
<h2>Bienvenue <span id="currentUser"></span></h2>
<button onclick="openGuestWindow()">Gestion des invités</button>
<button onclick="simulateMassRecords()">Simuler 600000 enregistrements</button>
</div>

<script>
let currentUser = '';
let currentRole = '';
let records = {};
let users = {admin:{password:'admin123'}, user:{password:'user123'}};

function login() {
let username = document.getElementById('username').value;
let password = document.getElementById('password').value;
let role = document.getElementById('role').value;
if(!users[username] || users[username].password!==password || (role==='admin' && username!=='admin')){
alert('Identifiants invalides'); return;
}
currentUser = username;
currentRole = role;
if(!records[currentUser]) records[currentUser] = [];
document.getElementById('loginDiv').classList.add('hidden');
document.getElementById('mainDiv').classList.remove('hidden');
document.getElementById('currentUser').textContent = currentUser;
}

function openGuestWindow() {
let win = window.open('', 'Gestion Invités', 'width=1000,height=700');
win.document.write(`<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Invités - ${currentUser}</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
input, select { margin: 5px; padding: 5px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
button { padding: 5px 10px; margin: 5px; }
#pagination button { margin: 2px; }
</style>
</head>
<body>
<h2>Enregistrement invités - ${currentUser}</h2>
<form id="guestForm">
<select id="appartement" required>
<option value="">Appartement</option>
<option value="A1">A1</option>
<option value="A2">A2</option>
<option value="B1">B1</option>
</select>
<select id="batiment" required>
<option value="">Bâtiment</option>
<option value="Bâtiment 1">Bâtiment 1</option>
<option value="Bâtiment 2">Bâtiment 2</option>
</select>
<input type="number" id="nbInvites" placeholder="Nombre d'invités" required>
<input type="text" id="nomPrenom" placeholder="Nom et Prénom" required>
<input type="text" id="idDoc" placeholder="Passeport ou Carte Nationale" required>
<input type="date" id="dateArrivee" required>
<button type="submit">Enregistrer</button>
</form>

<input type="text" id="searchInput" placeholder="Recherche nom, appartement, batiment">

<div id="records">
<table>
<thead>
<tr>
<th>Appartement</th>
<th>Bâtiment</th>
<th>Nb Invités</th>
<th>Nom & Prénom</th>
<th>ID</th>
<th>Date Arrivée</th>
<th>QR Code</th>
</tr>
</thead>
<tbody id="recordBody"></tbody>
</table>
<div id="pagination"></div>
</div>

<script>
let allRecords = window.opener.records['${currentUser}'] || [];
let filteredRecords = allRecords;
let currentPage = 1;
let perPage = 100;

document.getElementById('guestForm').addEventListener('submit', function(e){
e.preventDefault();
let appartement = document.getElementById('appartement').value;
let batiment = document.getElementById('batiment').value;
let nbInvites = document.getElementById('nbInvites').value;
let nomPrenom = document.getElementById('nomPrenom').value;
let idDoc = document.getElementById('idDoc').value;
let dateArrivee = document.getElementById('dateArrivee').value;
if(!appartement || !batiment || !nbInvites || !nomPrenom || !idDoc || !dateArrivee) return;
allRecords.push({appartement, batiment, nbInvites, nomPrenom, idDoc, dateArrivee});
filteredRecords = allRecords;
renderPage(1);
this.reset();
});

document.getElementById('searchInput').addEventListener('input', function() {
let term = this.value.toLowerCase();
filteredRecords = allRecords.filter(r => 
r.nomPrenom.toLowerCase().includes(term) ||
r.appartement.toLowerCase().includes(term) ||
r.batiment.toLowerCase().includes(term)
);
renderPage(1);
});

function renderPage(page) {
let tbody = document.getElementById('recordBody');
tbody.innerHTML = '';
let start = (page-1)*perPage;
let end = Math.min(start+perPage, filteredRecords.length);
for(let i=start;i<end;i++){
let r = filteredRecords[i];
let tr = document.createElement('tr');
tr.innerHTML = \`<td>\${r.appartement}</td>
<td>\${r.batiment}</td>
<td>\${r.nbInvites}</td>
<td>\${r.nomPrenom}</td>
<td>\${r.idDoc}</td>
<td>\${r.dateArrivee}</td>
<td id="qr\${i}"></td>\`;
tbody.appendChild(tr);
QRCode.toCanvas(document.getElementById(\`qr\${i}\`), JSON.stringify(r), {width: 60});
}
renderPagination();
}

function renderPagination() {
let totalPages = Math.ceil(filteredRecords.length/perPage);
let container = document.getElementById('pagination');
container.innerHTML = '';
for(let i=1;i<=totalPages;i++){
let btn = document.createElement('button');
btn.textContent = i;
btn.disabled = (i===currentPage);
btn.onclick = ()=>{currentPage=i; renderPage(currentPage);}
container.appendChild(btn);
}
}

renderPage(1);
</script>
</body>
</html>`);
}

function simulateMassRecords() {
if(!records[currentUser]) records[currentUser] = [];
for(let i=0;i<600000;i++){
records[currentUser].push({appartement:'A1', batiment:'B1', nbInvites:1, nomPrenom:'Invité '+i, idDoc:'ID'+i, dateArrivee:'2025-08-16'});
}
alert('600000 enregistrements simulés pour ' + currentUser);
}
</script>

</body>
</html>