<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Enregistrement des invités</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --c1:#007bff; --bg:#f0f2f5; --ok:#0f9d58; --warn:#f4b400;
      --err:#d93025; --info:#4285f4;
    }
    body { font-family: Arial, sans-serif; margin: 16px; background: var(--bg); }
    h2 { text-align: center; margin: 8px 0 16px; }
    .card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.12); margin-bottom:16px; }
    label { font-weight:600; display:block; margin-top:10px; }
    input, button { font-size:16px; }
    input { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:8px; }
    input[readonly]{ background:#e9ecef; }
    button { margin-top:14px; padding:10px 14px; border:none; border-radius:10px; background:var(--c1); color:#fff; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border:1px solid #e5e7eb; padding:8px; text-align:center; }
    th { background:var(--c1); color:#fff; }
    .hidden{ display:none !important; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1 1 220px; min-width:220px; }
    .banner{ padding:10px 12px; border-radius:10px; margin-bottom:12px; font-weight:600; }
    .banner.info{ background:#e8f0fe; color:#174ea6; border:1px solid #c6dafc; }
    .banner.ok{ background:#e6f4ea; color:#137333; border:1px solid #cce8d3; }
    .banner.warn{ background:#fef7e0; color:#a66300; border:1px solid #fde293; }
    .banner.err{ background:#fce8e6; color:#a50e0e; border:1px solid #f7b9b4; }
    .toolbar{ display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap; }
    .note{ font-size:13px; opacity:.8; }
    .qrwrap{ display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; }
    .recap{ background:#fafafa; border:1px dashed #ccc; padding:10px; border-radius:8px; min-width:240px; }
  </style>
</head>
<body>
  <h2>Enregistrement des invités</h2>
  <div id="banner" class="banner info hidden"></div>

  <!-- Connexion -->
  <div id="loginCard" class="card">
    <div class="toolbar">
      <div><strong>Connexion</strong></div>
      <div class="note">Comptes : <strong>admin / admin</strong> • Test : <strong>66 / 12</strong></div>
    </div>
    <label>Utilisateur</label>
    <input type="text" id="loginUser" autocomplete="username" placeholder="admin ou 66" required />
    <label>Mot de passe</label>
    <input type="password" id="loginPass" autocomplete="current-password" placeholder="admin ou 12" required />
    <button id="btnLogin" onclick="login()" disabled>Connexion</button>
    <p id="loginMsg" class="banner err hidden"></p>
  </div>

  <!-- Interface Admin -->
  <div id="adminPanel" class="hidden">
    <div class="toolbar card">
      <div><strong>Panneau administrateur</strong></div>
      <div><button onclick="logout()">Déconnexion</button></div>
    </div>
    <div class="card">
      <h3>Gestion des utilisateurs</h3>
      <div class="row">
        <div class="col"><label>Appartement</label><input type="text" id="appartAdmin" required /></div>
        <div class="col"><label>Bâtiment</label><input type="text" id="batAdmin" required /></div>
        <div class="col"><label>Mot de passe</label><input type="text" id="passAdmin" required /></div>
      </div>
      <button onclick="creerUtilisateur()">Créer utilisateur</button>
      <p class="note">L’identifiant utilisateur sera <i>Appartement+Bâtiment</i> (ex. 6 et 6 → <b>66</b>).</p>
      <div id="userWarn" class="banner warn hidden"></div>
    </div>
    <div class="card">
      <h3>Liste des utilisateurs</h3>
      <table id="tableUsers">
        <thead><tr><th>Utilisateur</th><th>Appartement</th><th>Bâtiment</th><th>Mot de passe</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card">
      <h3>Tous les enregistrements (derniers ajoutés)</h3>
      <table id="tableAdmin">
        <thead><tr><th>ID</th><th>Appartement</th><th>Bâtiment</th><th>Nom principal</th><th>Total personnes</th><th>Date</th><th>WhatsApp</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Interface Utilisateur -->
  <div id="userPanel" class="hidden">
    <div class="toolbar card">
      <div><strong>Mon espace</strong></div>
      <div><button onclick="logout()">Déconnexion</button></div>
    </div>
    <div class="card">
      <h3>Mes enregistrements</h3>
      <table id="tableUser">
        <thead><tr><th>ID</th><th>Nom principal</th><th>Total personnes</th><th>Date</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
      <button onclick="genererLien()">Générer le lien d’enregistrement invité</button>
      <p id="lienInvite" class="note"></p>
    </div>
  </div>

  <!-- Formulaire d’invité (via lien) -->
  <div id="invitePanel" class="hidden">
    <div class="card">
      <div class="toolbar">
        <h3>Enregistrement Invité</h3>
        <button onclick="retourAccueil()">Retour</button>
      </div>
      <div class="row">
        <div class="col"><label>Appartement</label><input type="text" id="invAppart" readonly /></div>
        <div class="col"><label>Bâtiment</label><input type="text" id="invBat" readonly /></div>
      </div>
      <label>Nom et Prénom (personne principale)</label>
      <input type="text" id="nomPrincipal" required />
      <label>Passeport / CNI (personne principale)</label>
      <input type="text" id="docPrincipal" required />
      <label>Nombre total de personnes</label>
      <input type="number" id="nbPers" min="1" value="1" required onchange="genererChamps()" />
      <div id="personnes"></div>
      <label>Date d’arrivée</label>
      <input type="date" id="dateArrivee" required />
      <button onclick="enregistrer()">Enregistrer</button>
      <div class="qrwrap">
        <div id="qrcode" style="margin-top:16px;"></div>
        <div id="recap" class="recap hidden"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script>
    /* =======================
       (Code JS identique sauf modifications principales dans enregistrer())
    ======================== */

    // ... (toute la logique IndexedDB, login, admin, refreshUser etc. inchangée)

    function enregistrer(){
      const nom = (document.getElementById('nomPrincipal').value || '').trim();
      const doc = (document.getElementById('docPrincipal').value || '').trim();
      const nb = parseInt(document.getElementById('nbPers').value || '0', 10);
      const date = document.getElementById('dateArrivee').value;
      if(!nom || !doc || !date || nb < 1){
        showBanner('warn',"Tous les champs sont obligatoires.");
        return;
      }
      const personnes = [];
      for(let i=1;i<=nb;i++){
        const v = (document.getElementById(`pers${i}`).value || '').trim();
        if(!v){ showBanner('warn',`Merci de renseigner la personne ${i}.`); return; }
        personnes.push(v);
      }
      const appart = document.getElementById('invAppart').value;
      const bat = document.getElementById('invBat').value;
      const rec = { appart, bat, nom, doc, personnes, date, sent:false };
      const msg = `Arrivée: ${date}\nAppartement: ${appart}\nBâtiment: ${bat}\nNom principal: ${nom}\nDoc: ${doc}\nNombre de personnes: ${personnes.length}\nListe: ${personnes.join(", ")}\n\n⚠️ Seules les personnes enregistrées sont autorisées.`;

      const st = tx('records','readwrite');
      const addReq = st.add(rec);
      addReq.onsuccess = (e)=>{
        const id = e.target.result;
        rec.id = id;
        showBanner('ok',"Enregistrement effectué avec succès.");
        document.getElementById('qrcode').innerHTML = '';
        new QRCode(document.getElementById('qrcode'), { text: msg, width: 200, height: 200 });
        const recap = document.getElementById('recap');
        recap.innerHTML = `<strong>Récapitulatif</strong><br>
          ID: ${id}<br>
          Appartement: ${appart} | Bâtiment: ${bat}<br>
          Nom principal: ${nom}<br>
          Document: ${doc}<br>
          Date d’arrivée: ${date}<br>
          Total personnes: <strong>${personnes.length}</strong><br>
          <div class="note" style="margin-top:8px;">
            Veuillez présenter ce QR code aux agents de sécurité en cas de besoin.<br>
            ⚠️ Seules les personnes enregistrées dans ce formulaire sont autorisées à entrer.
          </div>`;
        recap.classList.remove('hidden');
      };
    }
  </script>
</body>
</html>