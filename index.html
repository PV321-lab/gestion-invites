<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Système d'Enregistrement des Invités</title>
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
  <style>
    :root {
      --primary: #4285f4;
      --secondary: #34a853;
      --accent: #fbbc05;
      --light: #f8f9fa;
      --dark: #202124;
      --border: #dadce0;
      --success: #0f9d58;
      --error: #ea4335;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background: #f5f7fa;
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .container {
      width: 100%;
      max-width: 800px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    header {
      background: var(--primary);
      color: white;
      padding: 25px;
      text-align: center;
    }
    
    h1 {
      font-size: 2.2rem;
      margin-bottom: 10px;
    }
    
    .subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .drive-info {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      padding: 15px;
      margin: 20px 0 0;
      font-size: 0.9rem;
    }
    
    .content {
      padding: 30px;
    }
    
    .card {
      margin-bottom: 30px;
      padding: 25px;
      border-radius: 12px;
      background: var(--light);
      border: 1px solid var(--border);
    }
    
    h2 {
      font-size: 1.6rem;
      margin-bottom: 20px;
      color: var(--primary);
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border);
    }
    
    label {
      display: block;
      margin: 15px 0 8px;
      font-weight: 500;
      color: #5f6368;
    }
    
    input, select {
      width: 100%;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 16px;
      background: white;
      transition: all 0.3s;
    }
    
    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
    }
    
    input[readonly] {
      background-color: #f1f3f4;
    }
    
    button {
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--primary);
      color: white;
    }
    
    button:hover {
      background: #3367d6;
      transform: translateY(-2px);
    }
    
    .btn-success {
      background: var(--success);
    }
    
    .btn-success:hover {
      background: #0d8045;
    }
    
    .btn-error {
      background: var(--error);
    }
    
    .btn-error:hover {
      background: #c5221f;
    }
    
    .banner {
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      font-weight: 500;
    }
    
    .banner-success {
      background: #e6f4ea;
      color: #137333;
      border: 1px solid #cce8d3;
    }
    
    .banner-error {
      background: #fce8e6;
      color: #a50e0e;
      border: 1px solid #f7b9b4;
    }
    
    .person-group {
      background: #f8fafc;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border: 1px solid var(--border);
    }
    
    .qr-container {
      text-align: center;
      margin: 25px 0;
    }
    
    .qr-placeholder {
      width: 250px;
      height: 250px;
      background: #f0f4f8;
      border: 2px dashed var(--border);
      border-radius: 12px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #5f6368;
    }
    
    .hidden {
      display: none;
    }
    
    .row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .col {
      flex: 1;
    }
    
    footer {
      text-align: center;
      padding: 20px;
      background: var(--light);
      color: #5f6368;
      font-size: 0.9rem;
    }
    
    @media (max-width: 600px) {
      .row {
        flex-direction: column;
        gap: 10px;
      }
      
      .content {
        padding: 20px;
      }
      
      .card {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Enregistrement des Invités</h1>
      <p class="subtitle">Solution simplifiée avec stockage sur Google Drive</p>
      
      <div class="drive-info">
        <p>Données sauvegardées sur votre Google Drive</p>
        <p><strong>Lien Drive:</strong> https://drive.google.com/file/d/14wELs33cLxi76AsZtDIIb6N7ZFwi7LET</p>
      </div>
    </header>

    <div class="content">
      <!-- Formulaire d'invitation principal -->
      <div id="invitePanel">
        <div class="card">
          <h2>Enregistrement d'Invitation</h2>
          
          <div class="row">
            <div class="col">
              <label>Appartement</label>
              <input type="text" id="invAppart" value="6" readonly>
            </div>
            <div class="col">
              <label>Bâtiment</label>
              <input type="text" id="invBat" value="6" readonly>
            </div>
          </div>

          <label>Date d'arrivée</label>
          <input type="date" id="dateArrivee" required>

          <label>Nombre total de personnes</label>
          <input type="number" id="nbPers" min="1" value="1" required>

          <div class="person-group">
            <h3>Personne principale</h3>
            <label>Nom & Prénom</label>
            <input type="text" id="nomPrincipal" required placeholder="Nom complet">
            
            <label>Passeport / CNI</label>
            <input type="text" id="docPrincipal" required placeholder="Numéro de document">
          </div>

          <div id="personnesContainer"></div>

          <button id="registerGuestBtn">Enregistrer les invités</button>
          
          <div id="registerMsg" class="banner banner-error hidden">
            Erreur lors de la sauvegarde sur Google Drive. Veuillez réessayer.
          </div>
        </div>
        
        <div class="card">
          <div class="qr-container">
            <h3>QR Code d'accès</h3>
            <div id="qrcode" class="qr-placeholder">
              Le QR code apparaîtra après l'enregistrement
            </div>
            <button id="downloadQRBtn" class="btn-success hidden">Télécharger le QR Code</button>
          </div>
        </div>
      </div>

      <div id="successPanel" class="card hidden">
        <h2>Enregistrement Réussi!</h2>
        <p>Les données ont été sauvegardées avec succès sur Google Drive.</p>
        <p>Votre QR code d'accès a été généré.</p>
        
        <div class="qr-container">
          <div id="successQrcode"></div>
          <button id="successDownloadBtn" class="btn-success">Télécharger le QR Code</button>
        </div>
        
        <button id="newRegistrationBtn">Nouvel enregistrement</button>
      </div>
    </div>

    <footer>
      <p>Système d'Enregistrement des Invités &copy; 2023 - Stockage sécurisé sur Google Drive</p>
    </footer>
  </div>

  <script>
    // URL du script Google pour accéder à Google Drive
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxK1YdQb6BzT4Rw9Qr1rS0N0s7dKQ2hVj0X1wT4Jw4/exec";
    
    // Initialiser le QR code
    const qrCode = new QRCodeStyling({
      width: 250,
      height: 250,
      margin: 10,
      qrOptions: { typeNumber: 0, mode: "Byte", errorCorrectionLevel: "H" },
      dotsOptions: { color: "#1E40AF", type: "rounded" },
      backgroundOptions: { color: "#FFFFFF" },
      cornersSquareOptions: { type: "extra-rounded", color: "#1E40AF" },
      cornersDotOptions: { type: "dot", color: "#1E40AF" }
    });
    
    // Fonction pour générer des champs pour les personnes supplémentaires
    function generatePersonFields() {
      const nbPers = parseInt(document.getElementById('nbPers').value) || 1;
      const container = document.getElementById('personnesContainer');
      container.innerHTML = '';
      
      for (let i = 2; i <= nbPers; i++) {
        const personGroup = document.createElement('div');
        personGroup.className = 'person-group';
        personGroup.innerHTML = `
          <h3>Personne ${i}</h3>
          <label>Nom & Prénom</label>
          <input type="text" id="pers${i}Nom" required placeholder="Nom complet">
          
          <label>Passeport / CNI</label>
          <input type="text" id="pers${i}Doc" required placeholder="Numéro de document">
        `;
        container.appendChild(personGroup);
      }
    }
    
    // Fonction pour sauvegarder les données sur Google Drive
    async function saveToGoogleDrive(data) {
      try {
        // Afficher l'indicateur de chargement
        document.getElementById('registerMsg').textContent = "Sauvegarde sur Google Drive...";
        document.getElementById('registerMsg').classList.remove('hidden');
        document.getElementById('registerMsg').classList.remove('banner-error');
        document.getElementById('registerMsg').classList.add('banner-success');
        
        // Simuler un délai pour montrer le processus
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Envoyer les données au script Google
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'save',
            data: JSON.stringify(data)
          })
        });
        
        // Vérifier la réponse
        if (response.ok) {
          return true;
        } else {
          throw new Error('Erreur de réponse du serveur');
        }
      } catch (error) {
        console.error("Erreur de sauvegarde:", error);
        return false;
      }
    }
    
    // Fonction d'enregistrement d'un invité
    async function registerGuest() {
      const appart = document.getElementById('invAppart').value;
      const batiment = document.getElementById('invBat').value;
      const date = document.getElementById('dateArrivee').value;
      const nomPrincipal = document.getElementById('nomPrincipal').value;
      const docPrincipal = document.getElementById('docPrincipal').value;
      const nbPers = parseInt(document.getElementById('nbPers').value) || 1;
      
      // Validation des données
      if (!appart || !batiment || !date || !nomPrincipal || !docPrincipal) {
        document.getElementById('registerMsg').textContent = 'Veuillez remplir tous les champs obligatoires';
        document.getElementById('registerMsg').classList.remove('hidden');
        document.getElementById('registerMsg').classList.add('banner-error');
        return;
      }
      
      // Préparer les données des personnes
      const personnes = [{
        nom: nomPrincipal,
        doc: docPrincipal
      }];
      
      for (let i = 2; i <= nbPers; i++) {
        const nom = document.getElementById(`pers${i}Nom`)?.value || '';
        const doc = document.getElementById(`pers${i}Doc`)?.value || '';
        
        if (nom && doc) {
          personnes.push({ nom, doc });
        }
      }
      
      // Créer l'objet d'enregistrement
      const registration = {
        id: Date.now(),
        appart,
        batiment,
        date,
        personnes,
        timestamp: new Date().toISOString()
      };
      
      // Sauvegarder sur Google Drive
      const success = await saveToGoogleDrive(registration);
      
      if (success) {
        // Afficher le QR code
        const qrData = JSON.stringify({
          appart,
          batiment,
          date,
          personnes
        });
        
        qrCode.update({ data: qrData });
        document.getElementById('qrcode').innerHTML = '';
        qrCode.append(document.getElementById('qrcode'));
        document.getElementById('downloadQRBtn').classList.remove('hidden');
        
        // Afficher le message de succès
        document.getElementById('registerMsg').textContent = 'Enregistrement réussi! Les données ont été sauvegardées sur Google Drive.';
        document.getElementById('registerMsg').classList.remove('banner-error');
        document.getElementById('registerMsg').classList.add('banner-success');
        
        // Afficher le panneau de succès après un court délai
        setTimeout(() => {
          document.getElementById('invitePanel').classList.add('hidden');
          document.getElementById('successPanel').classList.remove('hidden');
          document.getElementById('successQrcode').innerHTML = '';
          qrCode.append(document.getElementById('successQrcode'));
        }, 1500);
      } else {
        document.getElementById('registerMsg').textContent = 'Erreur lors de la sauvegarde sur Google Drive. Veuillez réessayer.';
        document.getElementById('registerMsg').classList.remove('banner-success');
        document.getElementById('registerMsg').classList.add('banner-error');
      }
    }
    
    // Initialiser l'application au chargement
    document.addEventListener('DOMContentLoaded', () => {
      // Définir la date d'aujourd'hui comme valeur par défaut
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateArrivee').value = today;
      
      // Générer les champs initiaux
      generatePersonFields();
      
      // Configurer les événements
      document.getElementById('nbPers').addEventListener('change', generatePersonFields);
      document.getElementById('registerGuestBtn').addEventListener('click', registerGuest);
      document.getElementById('downloadQRBtn').addEventListener('click', () => {
        qrCode.download({ name: "Guest_QR_Code", extension: "png" });
      });
      document.getElementById('successDownloadBtn').addEventListener('click', () => {
        qrCode.download({ name: "Guest_QR_Code", extension: "png" });
      });
      document.getElementById('newRegistrationBtn').addEventListener('click', () => {
        document.getElementById('successPanel').classList.add('hidden');
        document.getElementById('invitePanel').classList.remove('hidden');
        document.getElementById('registerMsg').classList.add('hidden');
        
        // Réinitialiser le formulaire
        document.getElementById('nomPrincipal').value = '';
        document.getElementById('docPrincipal').value = '';
        document.getElementById('nbPers').value = '1';
        generatePersonFields();
      });
    });
  </script>
</body>
</html>