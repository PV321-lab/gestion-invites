<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Enregistrement des invités</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --c1:#007bff; --bg:#f0f2f5; --ok:#0f9d58; --warn:#f4b400; --err:#d93025; --info:#4285f4;
    }
    body { font-family: Arial, sans-serif; margin: 16px; background: var(--bg); }
    h2 { text-align: center; margin: 8px 0 16px; }
    .card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.12); margin-bottom:16px; }
    label { font-weight:600; display:block; margin-top:10px; }
    input, button { font-size:16px; }
    input { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:8px; }
    input[readonly]{ background:#e9ecef; }
    button { margin-top:14px; padding:10px 14px; border:none; border-radius:10px; background:var(--c1); color:#fff; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border:1px solid #e5e7eb; padding:8px; text-align:center; }
    th { background:var(--c1); color:#fff; }
    .hidden{ display:none !important; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1 1 220px; min-width:220px; }
    .banner{ padding:10px 12px; border-radius:10px; margin-bottom:12px; font-weight:600; }
    .banner.info{ background:#e8f0fe; color:#174ea6; border:1px solid #c6dafc; }
    .banner.ok{ background:#e6f4ea; color:#137333; border:1px solid #cce8d3; }
    .banner.warn{ background:#fef7e0; color:#a66300; border:1px solid #fde293; }
    .banner.err{ background:#fce8e6; color:#a50e0e; border:1px solid #f7b9b4; }
    .toolbar{ display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap; }
    .note{ font-size:13px; opacity:.8; }
    .qrwrap{ display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; }
    .recap{ background:#fafafa; border:1px dashed #ccc; padding:10px; border-radius:8px; min-width:240px; }
  </style>
</head>
<body>

  <h2>Enregistrement des invités</h2>

  <div id="banner" class="banner info hidden"></div>

  <!-- Connexion -->
  <div id="loginCard" class="card">
    <div class="toolbar">
      <div><strong>Connexion</strong></div>
      <div class="note">Comptes : <strong>admin / admin</strong> • Test : <strong>66 / 12</strong></div>
    </div>
    <label>Utilisateur</label>
    <input type="text" id="loginUser" autocomplete="username" placeholder="admin ou 66" required />
    <label>Mot de passe</label>
    <input type="password" id="loginPass" autocomplete="current-password" placeholder="admin ou 12" required />
    <button id="btnLogin" onclick="login()" disabled>Connexion</button>
    <p id="loginMsg" class="banner err hidden"></p>
  </div>

  <!-- Interface Admin -->
  <div id="adminPanel" class="hidden">
    <div class="toolbar card">
      <div><strong>Panneau administrateur</strong></div>
      <div>
        <button onclick="logout()">Déconnexion</button>
      </div>
    </div>

    <div class="card">
      <h3>Gestion des utilisateurs</h3>
      <div class="row">
        <div class="col">
          <label>Appartement</label>
          <input type="text" id="appartAdmin" inputmode="numeric" required />
        </div>
        <div class="col">
          <label>Bâtiment</label>
          <input type="text" id="batAdmin" required />
        </div>
        <div class="col">
          <label>Mot de passe</label>
          <input type="text" id="passAdmin" required />
        </div>
      </div>
      <button onclick="creerUtilisateur()">Créer utilisateur</button>
      <p class="note">L’identifiant utilisateur sera <i>Appartement+Bâtiment</i> (ex. 6 et 6 → <b>66</b>).</p>
      <div id="userWarn" class="banner warn hidden"></div>
    </div>

    <div class="card">
      <h3>Liste des utilisateurs</h3>
      <table id="tableUsers">
        <thead><tr><th>Utilisateur</th><th>Appartement</th><th>Bâtiment</th><th>Mot de passe</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Tous les enregistrements (derniers ajoutés)</h3>
      <table id="tableAdmin">
        <thead>
          <tr>
            <th>ID</th><th>Appartement</th><th>Bâtiment</th><th>Nom principal</th>
            <th>Total personnes</th><th>Date</th><th>WhatsApp</th><th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="note">Astuce : pour des bases énormes, ajoute un filtrage/pagination si besoin.</p>
    </div>
  </div>

  <!-- Interface Utilisateur -->
  <div id="userPanel" class="hidden">
    <div class="toolbar card">
      <div><strong>Mon espace</strong></div>
      <div><button onclick="logout()">Déconnexion</button></div>
    </div>

    <div class="card">
      <h3>Mes enregistrements</h3>
      <table id="tableUser">
        <thead>
          <tr><th>ID</th><th>Nom principal</th><th>Total personnes</th><th>Date</th><th>Status</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="genererLien()">Générer le lien d’enregistrement invité</button>
      <p id="lienInvite" class="note"></p>
    </div>
  </div>

  <!-- Formulaire d’invité (via lien) -->
  <div id="invitePanel" class="hidden">
    <div class="card">
      <div class="toolbar">
        <h3>Enregistrement Invité</h3>
        <button onclick="retourAccueil()">Retour</button>
      </div>
      <div class="row">
        <div class="col">
          <label>Appartement</label>
          <input type="text" id="invAppart" readonly />
        </div>
        <div class="col">
          <label>Bâtiment</label>
          <input type="text" id="invBat" readonly />
        </div>
      </div>

      <label>Nom / Prénom (personne principale)</label>
      <input type="text" id="nomPrincipal" required />

      <label>Passeport / CNI (personne principale)</label>
      <input type="text" id="docPrincipal" required />

      <label>Nombre total de personnes</label>
      <input type="number" id="nbPers" min="1" value="1" required onchange="genererChamps()" />

      <div id="personnes"></div>

      <label>Date d’arrivée</label>
      <input type="date" id="dateArrivee" required />

      <button onclick="enregistrer()">Enregistrer</button>

      <div class="qrwrap">
        <div id="qrcode" style="margin-top:16px;"></div>
        <div id="recap" class="recap hidden"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script>
    /* =======================
       ÉTAT / CONSTANTES
    ======================== */
    let db;
    let currentUser = null;
    const SESSION_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes
    let sessionTimer = null;

    // Banner helpers
    function showBanner(type, text){
      const b = document.getElementById('banner');
      b.className = 'banner ' + type;
      b.textContent = text;
      b.classList.remove('hidden');
    }
    function hideBanner(){ document.getElementById('banner').classList.add('hidden'); }

    function showInlineMsg(elId, type, text){
      const el = document.getElementById(elId);
      el.textContent = text;
      el.className = 'banner ' + type;
      el.classList.remove('hidden');
    }
    function hideInlineMsg(elId){
      const el = document.getElementById(elId);
      el.classList.add('hidden');
    }

    /* =======================
       INDEXEDDB (grandes données)
    ======================== */
    let dbReadyResolve;
    const dbReady = new Promise(res => dbReadyResolve = res);

    const openReq = indexedDB.open("enregistrementsDB_v2", 2);
    openReq.onupgradeneeded = (e)=>{
      const _db = e.target.result;
      // users
      if(!_db.objectStoreNames.contains("users")){
        _db.createObjectStore("users", { keyPath: "user" });
      }
      // records
      if(!_db.objectStoreNames.contains("records")){
        const st = _db.createObjectStore("records", { keyPath: "id", autoIncrement: true });
        st.createIndex("byUnit", ["appart","bat"], { unique:false });
        st.createIndex("byDate", "date", { unique:false });
      } else {
        const st = e.target.transaction.objectStore("records");
        if(!st.indexNames.contains("byUnit")) st.createIndex("byUnit", ["appart","bat"], { unique:false });
        if(!st.indexNames.contains("byDate")) st.createIndex("byDate", "date", { unique:false });
      }
    };
    openReq.onsuccess = async (e)=>{
      db = e.target.result;
      await seedDefaultUser(); // crée 66/12 si absent
      document.getElementById('btnLogin').disabled = false;
      dbReadyResolve();
      // Si lien invité présent, basculer en mode invité
      const params = new URLSearchParams(location.search);
      if(params.has("invite")) enterInviteMode(params.get("invite"));
    };
    openReq.onerror = ()=>{
      showBanner('err', "Erreur d'ouverture de la base locale. Réessaie après avoir vidé le stockage du navigateur.");
    };

    function tx(storeName, mode='readonly'){
      return db.transaction(storeName, mode).objectStore(storeName);
    }

    async function seedDefaultUser(){
      return new Promise((resolve)=>{
        const st = tx('users');
        const getReq = st.get('66');
        getReq.onsuccess = ()=>{
          if(!getReq.result){
            const stw = tx('users','readwrite');
            stw.put({ user:'66', appart:'6', bat:'6', pass:'12' }).onsuccess = resolve;
            stw.transaction.oncomplete = resolve;
          } else resolve();
        };
        getReq.onerror = resolve;
      });
    }

    /* =======================
       SESSION / SÉCURITÉ
    ======================== */
    function startSessionTimer(){
      stopSessionTimer();
      sessionTimer = setTimeout(()=>{
        logout(true);
        showBanner('warn', "Session expirée (inactivité). Veuillez vous reconnecter.");
      }, SESSION_TIMEOUT_MS);
    }
    function stopSessionTimer(){
      if(sessionTimer){ clearTimeout(sessionTimer); sessionTimer = null; }
    }
    function resetSessionTimer(){
      if(currentUser) startSessionTimer();
    }
    ['click','keydown','touchstart'].forEach(evt=>{
      document.addEventListener(evt, resetSessionTimer, {passive:true});
    });

    function logout(expired=false){
      currentUser = null;
      stopSessionTimer();
      // UI reset
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('userPanel').classList.add('hidden');
      document.getElementById('invitePanel').classList.add('hidden');
      document.getElementById('loginCard').classList.remove('hidden');
      if(!expired) showBanner('info', "Vous êtes déconnecté.");
    }

    function retourAccueil(){
      window.history.replaceState({}, document.title, location.pathname); // nettoie ?invite
      logout(false);
    }

    /* =======================
       AUTH
    ======================== */
    async function login(){
      hideInlineMsg('loginMsg');
      await dbReady;
      const u = document.getElementById('loginUser').value.trim();
      const p = document.getElementById('loginPass').value.trim();

      if(!u || !p){
        showInlineMsg('loginMsg','err',"Saisissez l’utilisateur et le mot de passe.");
        return;
      }

      if(u === 'admin' && p === 'admin'){
        currentUser = { role:'admin' };
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        showBanner('ok', "Connecté en tant qu’administrateur.");
        startSessionTimer();
        refreshAdmin();
        return;
      }

      const st = tx('users');
      const req = st.get(u);
      req.onsuccess = ()=>{
        const user = req.result;
        if(user && user.pass === p){
          currentUser = { role:'user', id:user.user, appart:user.appart, bat:user.bat };
          document.getElementById('loginCard').classList.add('hidden');
          document.getElementById('userPanel').classList.remove('hidden');
          showBanner('ok', `Connecté. Appartement ${user.appart} / Immeuble ${user.bat}.`);
          startSessionTimer();
          refreshUser();
        } else {
          showInlineMsg('loginMsg','err',"Identifiants incorrects.");
        }
      };
      req.onerror = ()=> showInlineMsg('loginMsg','err',"Erreur d’accès à la base locale.");
    }

    /* =======================
       ADMIN : UTILISATEURS
    ======================== */
    function creerUtilisateur(){
      hideInlineMsg('userWarn');
      const appart = (document.getElementById('appartAdmin').value || '').trim();
      const bat = (document.getElementById('batAdmin').value || '').trim();
      const pass = (document.getElementById('passAdmin').value || '').trim();
      if(!appart || !bat || !pass){
        showInlineMsg('userWarn','warn',"Tous les champs utilisateur sont obligatoires.");
        return;
      }
      const userId = appart + bat;
      const st = tx('users','readwrite');
      const get = st.get(userId);
      get.onsuccess = ()=>{
        if(get.result){
          showInlineMsg('userWarn','warn',`L’utilisateur ${userId} existe déjà.`);
        } else {
          st.put({ user:userId, appart, bat, pass }).onsuccess = ()=>{
            showBanner('ok', `Utilisateur ${userId} créé.`);
            refreshAdmin();
          };
          st.transaction.onerror = ()=> showInlineMsg('userWarn','err',"Erreur lors de la création de l’utilisateur.");
        }
      };
      get.onerror = ()=> showInlineMsg('userWarn','err',"Erreur d’accès à la base locale.");
    }

    function refreshAdmin(){
      // Liste utilisateurs
      const tbodyU = document.querySelector('#tableUsers tbody');
      tbodyU.innerHTML = '';
      tx('users').openCursor().onsuccess = (e)=>{
        const c = e.target.result;
        if(c){
          const u = c.value;
          tbodyU.insertAdjacentHTML('beforeend',
            `<tr><td>${u.user}</td><td>${u.appart}</td><td>${u.bat}</td><td>${u.pass}</td></tr>`);
          c.continue();
        }
      };

      // Enregistrements (affiche les 200 derniers max pour rester fluide)
      const tbody = document.querySelector('#tableAdmin tbody');
      tbody.innerHTML = '';
      const all = [];
      tx('records').openCursor(null, 'next').onsuccess = (e)=>{
        const c = e.target.result;
        if(c){ all.push(c.value); c.continue(); }
        else {
          const last = all.slice(-200); // limiter l’affichage
          last.forEach(r=>{
            const id = r.id ?? '';
            const sendBtn = `<button onclick="envoyerWhatsApp(${id})">Envoyer</button>`;
            tbody.insertAdjacentHTML('beforeend',
              `<tr>
                <td>${id}</td>
                <td>${r.appart}</td>
                <td>${r.bat}</td>
                <td>${r.nom}</td>
                <td>${r.personnes.length}</td>
                <td>${r.date}</td>
                <td>${sendBtn}</td>
                <td>${r.sent ? "Envoyé" : "Non envoyé"}</td>
              </tr>`);
          });
        }
      };
    }

    /* =======================
       UTILISATEUR : MES ENREG.
    ======================== */
    function refreshUser(){
      const tbody = document.querySelector('#tableUser tbody');
      tbody.innerHTML = '';
      const idx = tx('records').index('byUnit');
      const req = idx.getAll([currentUser.appart, currentUser.bat]);
      req.onsuccess = ()=>{
        const arr = req.result || [];
        arr.slice(-200).forEach(r=>{
          tbody.insertAdjacentHTML('beforeend',
            `<tr>
              <td>${r.id ?? ''}</td>
              <td>${r.nom}</td>
              <td>${r.personnes.length}</td>
              <td>${r.date}</td>
              <td>${r.sent ? "Envoyé" : "Non envoyé"}</td>
            </tr>`);
        });
      };
      req.onerror = ()=> showBanner('err',"Erreur de lecture des enregistrements.");
    }

    function genererLien(){
      const base = location.href.split('?')[0];
      const lien = `${base}?invite=${encodeURIComponent(currentUser.id)}`;
      const p = document.getElementById('lienInvite');
      p.innerHTML = `Lien pour vos invités : <a href="${lien}" target="_blank">${lien}</a>`;
      showBanner('info', "Copiez/partagez ce lien avec vos invités.");
    }

    /* =======================
       MODE INVITÉ
    ======================== */
    async function enterInviteMode(userId){
      await dbReady;
      const st = tx('users');
      st.get(userId).onsuccess = (e)=>{
        const user = e.target.result;
        if(!user){
          showBanner('err',"Lien invalide ou utilisateur introuvable.");
          return;
        }
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('invitePanel').classList.remove('hidden');
        document.getElementById('invAppart').value = user.appart;
        document.getElementById('invBat').value = user.bat;
        genererChamps(); // init 1 personne
        hideBanner();
      };
    }

    function genererChamps(){
      const nb = Math.max(1, parseInt(document.getElementById('nbPers').value || '1', 10));
      const cont = document.getElementById('personnes');
      cont.innerHTML = '';
      for(let i=1;i<=nb;i++){
        const wrap = document.createElement('div');
        const lab = document.createElement('label');
        lab.textContent = `Personne ${i} - Nom & Prénom`;
        const inp = document.createElement('input');
        inp.id = `pers${i}`;
        inp.required = true;
        wrap.appendChild(lab); wrap.appendChild(inp);
        cont.appendChild(wrap);
      }
    }

    function buildMessage(rec){
      const nb = rec.personnes.length;
      const nomPrincipal = rec.nom;
      const autres = rec.personnes.slice(1);
      const autresFR = (autres.length? autres.join(", ") : "—");
      const autresAR = (autres.length? autres.join(", ") : "—");

      return `Salam :
Arrivée: ${rec.date}
Appartement: ${rec.appart}
Imm: ${rec.bat}
Nombre de personnes: ${nb} personnes
Réservation au nom de:
${nomPrincipal} (${nomPrincipal})

Autres personnes:
${autresFR}

NB : Svp pas d'autres personnes autorisées seul Les personnes figurent dans la réservation.

Merci
------------------------------------------
السلام عليكم:
الوصول: ${rec.date}
الشقة: ${rec.appart}
رقم العمارة: ${rec.bat}
عدد الأشخاص: ${nb} أشخاص
الحجز باسم: ${nomPrincipal} (${nomPrincipal})

أشخاص آخرون:
${autresAR}

ملاحظة: الرجاء عدم السماح لأي أشخاص آخرين، فقط الأشخاص المذكورين في الحجز.

شكرًا.`;
    }

    function enregistrer(){
      // validations
      const nom = (document.getElementById('nomPrincipal').value || '').trim();
      const doc = (document.getElementById('docPrincipal').value || '').trim();
      const nb = parseInt(document.getElementById('nbPers').value || '0', 10);
      const date = document.getElementById('dateArrivee').value;

      if(!nom || !doc || !date || !Number.isInteger(nb) || nb < 1){
        showBanner('warn',"Tous les champs sont obligatoires (y compris le nombre total de personnes).");
        return;
      }

      const personnes = [];
      for(let i=1;i<=nb;i++){
        const v = (document.getElementById(`pers${i}`).value || '').trim();
        if(!v){
          showBanner('warn',`Merci de renseigner la personne ${i}.`);
          return;
        }
        personnes.push(v);
      }

      const appart = document.getElementById('invAppart').value;
      const bat = document.getElementById('invBat').value;

      const rec = { appart, bat, nom, doc, personnes, date, sent:false };
      const msg = buildMessage(rec);

      const st = tx('records','readwrite');
      const addReq = st.add(rec);
      addReq.onsuccess = (e)=>{
        const id = e.target.result;
        rec.id = id; // pour usage immédiat (affichage)
        showBanner('ok',"Enregistrement effectué avec succès.");
        // QR code + récap
        document.getElementById('qrcode').innerHTML = '';
        new QRCode(document.getElementById('qrcode'), { text: msg, width: 200, height: 200 });
        const recap = document.getElementById('recap');
        recap.innerHTML = `<strong>Récapitulatif</strong><br>
          ID: ${id}<br>
          Total personnes: <strong>${personnes.length}</strong><br>
          Message: <pre style="white-space:pre-wrap;font-family:inherit;margin:8px 0;">${msg}</pre>
          <div class="note">Seules les personnes enregistrées sont autorisées à entrer.</div>`;
        recap.classList.remove('hidden');
      };
      addReq.onerror = ()=> showBanner('err',"Erreur lors de l’enregistrement. Réessayez.");
    }

    /* =======================
       ADMIN : ENVOI WHATSAPP
    ======================== */
    function envoyerWhatsApp(id){
      const st = tx('records');
      const get = st.get(id);
      get.onsuccess = ()=>{
        const r = get.result;
        if(!r){ showBanner('err',"Enregistrement introuvable."); return; }
        const msg = buildMessage(r);
        const url = "https://wa.me/?text=" + encodeURIComponent(msg);
        window.open(url, "_blank");
        // marquer envoyé
        const stw = tx('records','readwrite');
        r.sent = true;
        stw.put(r).onsuccess = ()=> refreshAdmin();
      };
      get.onerror = ()=> showBanner('err',"Erreur de lecture de l’enregistrement.");
    }

    /* =======================
       DÉMARRAGE
    ======================== */
    // Rien à faire ici : l’init DB active le bouton de login et gère le mode ?invite=...
  </script>
</body>
</html>