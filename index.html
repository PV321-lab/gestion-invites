Voici une version corrig√©e et am√©lior√©e de ton code, en tenant compte de tes remarques :

S√©curit√© :

Les identifiants de test (admin / admin, 66 / 12) ne s‚Äôaffichent plus en clair dans l‚Äôinterface ni dans les commentaires.

Les mots de passe ne sont pas list√©s dans les tableaux utilisateurs (seulement l‚Äôidentifiant, appartement et b√¢timent).

Formulaire d‚Äôinvit√©s :

Chaque invit√© (y compris le principal) doit fournir Nom & Pr√©nom + Passeport/CNI.

Tous les champs sont obligatoires.

Apr√®s enregistrement, le QR code est g√©n√©r√© avec toutes les informations.

Le r√©capitulatif affiche clairement le message : 

‚ö†Ô∏è Seules les personnes mentionn√©es dans cette r√©servation sont autoris√©es.

üëâ Voici le code corrig√© :

<!DOCTYPE html> <html lang="fr"> <head> <meta charset="UTF-8" /> <title>Enregistrement des invit√©s</title> <meta name="viewport" content="width=device-width, initial-scale=1" /> <style> :root{ --c1:#007bff; --bg:#f0f2f5; --ok:#0f9d58; --warn:#f4b400; --err:#d93025; --info:#4285f4; } body { font-family: Arial, sans-serif; margin: 16px; background: var(--bg); } h2 { text-align: center; margin: 8px 0 16px; } .card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.12); margin-bottom:16px; } label { font-weight:600; display:block; margin-top:10px; } input, button { font-size:16px; } input { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:8px; } input[readonly]{ background:#e9ecef; } button { margin-top:14px; padding:10px 14px; border:none; border-radius:10px; background:var(--c1); color:#fff; cursor:pointer; } button:disabled{ opacity:.6; cursor:not-allowed; } table { width:100%; border-collapse: collapse; margin-top: 10px; } th, td { border:1px solid #e5e7eb; padding:8px; text-align:center; } th { background:var(--c1); color:#fff; } .hidden{ display:none !important; } .row { display:flex; gap:12px; flex-wrap:wrap; } .col { flex:1 1 220px; min-width:220px; } .banner{ padding:10px 12px; border-radius:10px; margin-bottom:12px; font-weight:600; } .banner.info{ background:#e8f0fe; color:#174ea6; border:1px solid #c6dafc; } .banner.ok{ background:#e6f4ea; color:#137333; border:1px solid #cce8d3; } .banner.warn{ background:#fef7e0; color:#a66300; border:1px solid #fde293; } .banner.err{ background:#fce8e6; color:#a50e0e; border:1px solid #f7b9b4; } .toolbar{ display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap; } .note{ font-size:13px; opacity:.8; } .qrwrap{ display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; } .recap{ background:#fafafa; border:1px dashed #ccc; padding:10px; border-radius:8px; min-width:240px; } </style> </head> <body> <h2>Enregistrement des invit√©s</h2> <div id="banner" class="banner info hidden"></div> <!-- Connexion --> <div id="loginCard" class="card"> <div class="toolbar"> <div><strong>Connexion</strong></div> </div> <label>Utilisateur</label> <input type="text" id="loginUser" autocomplete="username" placeholder="Identifiant" required /> <label>Mot de passe</label> <input type="password" id="loginPass" autocomplete="current-password" placeholder="Mot de passe" required /> <button id="btnLogin" onclick="login()" disabled>Connexion</button> <p id="loginMsg" class="banner err hidden"></p> </div> <!-- Interface Admin --> <div id="adminPanel" class="hidden"> <div class="toolbar card"> <div><strong>Panneau administrateur</strong></div> <div><button onclick="logout()">D√©connexion</button></div> </div> <div class="card"> <h3>Gestion des utilisateurs</h3> <div class="row"> <div class="col"><label>Appartement</label><input type="text" id="appartAdmin" required /></div> <div class="col"><label>B√¢timent</label><input type="text" id="batAdmin" required /></div> <div class="col"><label>Mot de passe</label><input type="text" id="passAdmin" required /></div> </div> <button onclick="creerUtilisateur()">Cr√©er utilisateur</button> <p class="note">L‚Äôidentifiant utilisateur sera <i>Appartement+B√¢timent</i> (ex. 6 et 6 ‚Üí <b>66</b>).</p> <div id="userWarn" class="banner warn hidden"></div> </div> <div class="card"> <h3>Liste des utilisateurs</h3> <table id="tableUsers"> <thead><tr><th>Utilisateur</th><th>Appartement</th><th>B√¢timent</th></tr></thead> <tbody></tbody> </table> </div> <div class="card"> <h3>Tous les enregistrements (derniers ajout√©s)</h3> <table id="tableAdmin"> <thead><tr><th>ID</th><th>Appartement</th><th>B√¢timent</th><th>Nom principal</th><th>Total personnes</th><th>Date</th><th>Status</th></tr></thead> <tbody></tbody> </table> </div> </div> <!-- Interface Utilisateur --> <div id="userPanel" class="hidden"> <div class="toolbar card"> <div><strong>Mon espace</strong></div> <div><button onclick="logout()">D√©connexion</button></div> </div> <div class="card"> <h3>Mes enregistrements</h3> <table id="tableUser"> <thead><tr><th>ID</th><th>Nom principal</th><th>Total personnes</th><th>Date</th><th>Status</th></tr></thead> <tbody></tbody> </table> <button onclick="genererLien()">G√©n√©rer le lien d‚Äôenregistrement invit√©</button> <p id="lienInvite" class="note"></p> </div> </div> <!-- Formulaire d‚Äôinvit√© --> <div id="invitePanel" class="hidden"> <div class="card"> <div class="toolbar"> <h3>Enregistrement Invit√©</h3> <button onclick="retourAccueil()">Retour</button> </div> <div class="row"> <div class="col"><label>Appartement</label><input type="text" id="invAppart" readonly /></div> <div class="col"><label>B√¢timent</label><input type="text" id="invBat" readonly /></div> </div> <label>Nom et Pr√©nom (personne principale)</label> <input type="text" id="nomPrincipal" required /> <label>Passeport / CNI (personne principale)</label> <input type="text" id="docPrincipal" required /> <label>Nombre total de personnes</label> <input type="number" id="nbPers" min="1" value="1" required onchange="genererChamps()" /> <div id="personnes"></div> <label>Date d‚Äôarriv√©e</label> <input type="date" id="dateArrivee" required /> <button onclick="enregistrer()">Enregistrer</button> <div class="qrwrap"> <div id="qrcode" style="margin-top:16px;"></div> <div id="recap" class="recap hidden"></div> </div> </div> </div> <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script> <script> let db; let currentUser=null; const openReq = indexedDB.open("enregistrementsDB_v4", 1); openReq.onupgradeneeded = e=>{ const _db=e.target.result; if(!_db.objectStoreNames.contains("users")){ _db.createObjectStore("users",{keyPath:"user"}); } if(!_db.objectStoreNames.contains("records")){ const st=_db.createObjectStore("records",{keyPath:"id",autoIncrement:true}); st.createIndex("byUnit",["appart","bat"]); } }; openReq.onsuccess=e=>{ db=e.target.result; document.getElementById('btnLogin').disabled=false; const params=new URLSearchParams(location.search); if(params.has("invite")) enterInviteMode(params.get("invite")); }; function tx(store,mode="readonly"){return db.transaction(store,mode).objectStore(store);} function showBanner(type,text){const b=document.getElementById('banner');b.className='banner '+type;b.textContent=text;b.classList.remove('hidden');} function hideBanner(){document.getElementById('banner').classList.add('hidden');} function showInlineMsg(id,type,text){const el=document.getElementById(id);el.textContent=text;el.className='banner '+type;el.classList.remove('hidden');} function hideInlineMsg(id){document.getElementById(id).classList.add('hidden');} function login(){ hideInlineMsg('loginMsg'); const u=document.getElementById('loginUser').value.trim(); const p=document.getElementById('loginPass').value.trim(); if(!u||!p){showInlineMsg('loginMsg','err',"Champs obligatoires.");return;} if(u==="admin"&&p==="admin"){ currentUser={role:"admin"};document.getElementById('loginCard').classList.add('hidden'); document.getElementById('adminPanel').classList.remove('hidden');showBanner('ok',"Connect√© admin");refreshAdmin();return; } const st=tx('users');const req=st.get(u); req.onsuccess=()=>{const user=req.result; if(user&&user.pass===p){ currentUser={role:"user",id:user.user,appart:user.appart,bat:user.bat}; document.getElementById('loginCard').classList.add('hidden'); document.getElementById('userPanel').classList.remove('hidden'); showBanner('ok',`Connect√© ${user.appart}/${user.bat}`);refreshUser(); }else showInlineMsg('loginMsg','err',"Identifiants incorrects.");}; } function logout(){currentUser=null;document.getElementById('adminPanel').classList.add('hidden');document.getElementById('userPanel').classList.add('hidden');document.getElementById('invitePanel').classList.add('hidden');document.getElementById('loginCard').classList.remove('hidden');} function retourAccueil(){window.history.replaceState({},document.title,location.pathname);logout();} function creerUtilisateur(){ const appart=document.getElementById('appartAdmin').value.trim(); const bat=document.getElementById('batAdmin').value.trim(); const pass=document.getElementById('passAdmin').value.trim(); if(!appart||!bat||!pass){showInlineMsg('userWarn','warn',"Tous obligatoires.");return;} const id=appart+bat;const st=tx('users','readwrite');st.get(id).onsuccess=e=>{ if(e.target.result){showInlineMsg('userWarn','warn',"Existe d√©j√†");} else{st.put({user:id,appart,bat,pass}).onsuccess=()=>{showBanner('ok',"Utilisateur cr√©√©");refreshAdmin();};}}; } function refreshAdmin(){ const tbody=document.querySelector('#tableUsers tbody');tbody.innerHTML=''; tx('users').openCursor().onsuccess=e=>{const c=e.target.result;if(c){const u=c.value;tbody.insertAdjacentHTML('beforeend',`<tr><td>${u.user}</td><td>${u.appart}</td><td>${u.bat}</td></tr>`);c.continue();}}; const tbody2=document.querySelector('#tableAdmin tbody');tbody2.innerHTML=''; tx('records').openCursor().onsuccess=e=>{const c=e.target.result;if(c){const r=c.value;tbody2.insertAdjacentHTML('beforeend',`<tr><td>${r.id}</td><td>${r.appart}</td><td>${r.bat}</td><td>${r.nom}</td><td>${r.personnes.length}</td><td>${r.date}</td><td>${r.sent?"Envoy√©":"Non"}</td></tr>`);c.continue();}}; } function refreshUser(){ const tbody=document.querySelector('#tableUser tbody');tbody.innerHTML=''; const idx=tx('records').index('byUnit');idx.getAll([currentUser.appart,currentUser.bat]).onsuccess=e=>{ (e.target.result||[]).forEach(r=>{tbody.insertAdjacentHTML('beforeend',`<tr><td>${r.id}</td><td>${r.nom}</td><td>${r.personnes.length}</td><td>${r.date}</td><td>${r.sent?"Envoy√©":"Non"}</td></tr>`);}); }; } function genererLien(){const base=location.href.split('?')[0];const lien=`${base}?invite=${encodeURIComponent(currentUser.id)}`;document.getElementById('lienInvite').innerHTML=`Lien: <a href="${lien}" target="_blank">${lien}</a>`;showBanner('info',"Copiez ce lien.");} function enterInviteMode(userId){ tx('users').get(userId).onsuccess=e=>{ const user=e.target.result;if(!user){showBanner('err',"Lien invalide");return;} document.getElementById('loginCard').classList.add('hidden'); document.getElementById('invitePanel').classList.remove('hidden'); document.getElementById('invAppart').value=user.appart; document.getElementById('invBat').value=user.bat; genererChamps(); }; } function genererChamps(){ const nb=Math.max(1,parseInt(document.getElementById('nbPers').value||'1',10)); const cont=document.getElementById('personnes');cont.innerHTML=''; for(let i=1;i<=nb;i++){ const lab1=document.createElement('label');lab1.textContent=`Invit√© ${i} - Nom & Pr√©nom`; const inp1=document.createElement('input');inp1.id=`persNom${i}`;inp1.required=true; const lab2=document.createElement('label');lab2.textContent=`Invit√© ${i} - Passeport/CNI`; const inp2=document.createElement('input');inp2.id=`persDoc${i}`;inp2.required=true; cont.appendChild(lab1);cont.appendChild(inp1);cont.appendChild(lab2);cont.appendChild(inp2); } } function enregistrer(){ const nom=document.getElementById('nomPrincipal').value.trim(); const doc=document.getElementById('docPrincipal').value.trim(); const nb=parseInt(document.getElementById('nbPers').value||'0',10); const date=document.getElementById('dateArrivee').value; if(!nom||!doc||!date||nb<1){showBanner('warn',"Tous les champs obligatoires.");return;} const personnes=[];for(let i=1;i<=nb;i++){ const n=document.getElementById(`persNom${i}`).value.trim(); const d=document.getElementById(`persDoc${i}`).value.trim(); if(!n||!d){showBanner('warn',`Renseignez toutes les infos pour l'invit√© ${i}`);return;} personnes.push({nom:n,doc:d}); } const appart=document.getElementById('invAppart').value; const bat=document.getElementById('invBat').value; const rec={appart,bat,nom,doc,personnes,date,sent:false}; const msg=`Arriv√©e: ${date}\nAppartement: ${appart}\nB√¢timent: ${bat}\nNom principal: ${nom}\nDocument: ${doc}\nInvit√©s: ${personnes.map(p=>p.nom+" ("+p.doc+")").join(", ")}\n\n‚ö†Ô∏è Seules les personnes mentionn√©es dans ce formulaire sont autoris√©es.`; const st=tx('records','readwrite');st.add(rec).onsuccess=e=>{ const id=e.target.result;rec.id=id;showBanner('ok',"Enregistrement effectu√©."); document.getElementById('qrcode').innerHTML=''; new QRCode(document.getElementById('qrcode'),{text:msg,width:220,height:220}); const recap=document.getElementById('recap'); recap.innerHTML=`<strong>R√©capitulatif</strong><br> ID: ${id}<br> Appartement: ${appart} | B√¢timent: ${bat}<br> Nom principal: ${nom} (${doc})<br> Date d‚Äôarriv√©e: ${date}<br> Total personnes: <strong>${personnes.length}</strong 