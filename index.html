<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Système d'Enregistrement des Invités</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
  <style>
    :root {
      --c1: #007bff; --bg: #f0f2f5; --ok: #0f9d58; --warn: #f4b400; --err: #d93025; --info: #4285f4;
      --header: #1a73e8; --card-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e7eb 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
    }
    
    h1 {
      color: var(--header);
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      font-size: 1.1rem;
      max-width: 700px;
      margin: 0 auto;
    }
    
    .card {
      background: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      margin-bottom: 25px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }
    
    label {
      font-weight: 600;
      display: block;
      margin-top: 15px;
      color: #444;
    }
    
    input, button, select {
      font-size: 16px;
      font-family: inherit;
    }
    
    input {
      width: 100%;
      padding: 12px 15px;
      margin-top: 8px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #f9f9f9;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    
    input:focus {
      outline: none;
      border-color: var(--c1);
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }
    
    input[readonly] {
      background: #f0f4f8;
    }
    
    button {
      margin-top: 20px;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      background: var(--c1);
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s, transform 0.2s;
    }
    
    button:hover {
      background: #0069d9;
      transform: scale(1.02);
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    button.secondary {
      background: #6c757d;
    }
    
    button.secondary:hover {
      background: #5a6268;
    }
    
    button.success {
      background: var(--ok);
    }
    
    button.success:hover {
      background: #0c8749;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
    }
    
    th, td {
      border: 1px solid #e0e6ed;
      padding: 12px 15px;
      text-align: left;
    }
    
    th {
      background: var(--c1);
      color: white;
      font-weight: 600;
    }
    
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    tr:hover {
      background-color: #e9f0ff;
    }
    
    .hidden {
      display: none !important;
    }
    
    .row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    
    .col {
      flex: 1 1 250px;
      min-width: 250px;
    }
    
    .banner {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    .banner.info {
      background: #e8f0fe;
      color: #174ea6;
      border: 1px solid #c6dafc;
    }
    
    .banner.ok {
      background: #e6f4ea;
      color: #137333;
      border: 1px solid #cce8d3;
    }
    
    .banner.warn {
      background: #fef7e0;
      color: #a66300;
      border: 1px solid #fde293;
    }
    
    .banner.err {
      background: #fce8e6;
      color: #a50e0e;
      border: 1px solid #f7b9b4;
    }
    
    .toolbar {
      display: flex;
      gap: 15px;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .note {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
      line-height: 1.5;
    }
    
    .guest-form-container {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 800px;
      margin: 0 auto;
      box-shadow: var(--card-shadow);
    }
    
    .guest-form-title {
      font-size: 1.8rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 25px;
      color: #1e293b;
    }
    
    .guest-input {
      width: 100%;
      padding: 14px;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      font-size: 1rem;
      margin-top: 10px;
      background: #f8fafc;
    }
    
    .success-message {
      background: #dcfce7;
      color: #166534;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      font-weight: 600;
      margin-top: 25px;
      display: none;
      animation: fadeIn 0.5s ease;
    }
    
    .qrcode-container {
      margin-top: 30px;
      display: none;
      animation: fadeIn 0.8s ease;
    }
    
    .qrcode-header {
      font-size: 1.4rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 25px;
      color: #1e293b;
    }
    
    .qrcode-warning {
      background: #fffbeb;
      color: #854d0e;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      font-size: 1rem;
      text-align: center;
      border: 1px solid #fcd34d;
    }
    
    .download-button {
      background: #22c55e;
      color: white;
      border: none;
      padding: 14px 25px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 25px;
      display: block;
      width: 100%;
      transition: background 0.3s;
      font-size: 1.1rem;
    }
    
    .download-button:hover {
      background: #16a34a;
    }
    
    .person-group {
      background: #f8fafc;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid #e5e7eb;
    }
    
    .person-group h4 {
      margin-bottom: 15px;
      color: #1e293b;
    }
    
    .footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      color: #666;
      font-size: 0.9rem;
      border-top: 1px solid #eee;
    }
    
    .test-accounts {
      background: #f0f7ff;
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      border: 1px dashed #1a73e8;
    }
    
    .test-accounts h3 {
      margin-bottom: 10px;
      color: #1a73e8;
      text-align: center;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @media (max-width: 768px) {
      .row {
        flex-direction: column;
        gap: 15px;
      }
      
      .col {
        min-width: 100%;
      }
      
      .card {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Système d'Enregistrement des Invités</h1>
      <p class="subtitle">Gestion complète des résidents et de leurs invités avec génération de QR Code</p>
    </header>

    <div id="banner" class="banner info hidden"></div>

    <!-- Connexion -->
    <div id="loginCard" class="card">
      <div class="toolbar">
        <div><strong>Connexion au système</strong></div>
        <div class="note">Veuillez entrer vos identifiants pour accéder au système</div>
      </div>
      
      <div class="row">
        <div class="col">
          <label>Utilisateur</label>
          <input type="text" id="loginUser" autocomplete="username" placeholder="Identifiant" required value="66" />
        </div>
        <div class="col">
          <label>Mot de passe</label>
          <input type="password" id="loginPass" autocomplete="current-password" placeholder="Mot de passe" required value="15" />
        </div>
      </div>
      
      <button id="btnLogin" onclick="login()">Connexion</button>
      <p id="loginMsg" class="banner err hidden"></p>
      
      <div class="test-accounts">
        <h3>Comptes de test</h3>
        <div class="row">
          <div class="col">
            <strong>Administrateur</strong><br>
            Utilisateur: <code>admin</code><br>
            Mot de passe: <code>admin</code>
          </div>
          <div class="col">
            <strong>Utilisateur test</strong><br>
            Utilisateur: <code>66</code><br>
            Mot de passe: <code>15</code>
          </div>
        </div>
      </div>
    </div>

    <!-- Interface Admin -->
    <div id="adminPanel" class="hidden">
      <div class="toolbar card">
        <div><strong>Panneau Administrateur</strong></div>
        <div>
          <button onclick="logout()" class="secondary">Déconnexion</button>
        </div>
      </div>

      <div class="card">
        <h3>Gestion des utilisateurs</h3>
        <div class="row">
          <div class="col">
            <label>Appartement</label>
            <input type="text" id="appartAdmin" inputmode="numeric" required />
          </div>
          <div class="col">
            <label>Bâtiment</label>
            <input type="text" id="batAdmin" required />
          </div>
          <div class="col">
            <label>Mot de passe</label>
            <input type="text" id="passAdmin" required />
          </div>
        </div>
        <button onclick="creerUtilisateur()">Créer utilisateur</button>
        <p class="note">L'identifiant utilisateur sera généré automatiquement comme Appartement+Bâtiment (ex. 6 et 6 → 66).</p>
        <div id="userWarn" class="banner warn hidden"></div>
      </div>

      <div class="card">
        <h3>Liste des utilisateurs</h3>
        <table id="tableUsers">
          <thead><tr><th>Utilisateur</th><th>Appartement</th><th>Bâtiment</th><th>Mot de passe</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h3>Historique des enregistrements</h3>
        <table id="tableAdmin">
          <thead>
            <tr>
              <th>ID</th><th>Appartement</th><th>Bâtiment</th><th>Nom principal</th>
              <th>Document</th><th>Total personnes</th><th>Date</th><th>Action</th><th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p class="note">Les enregistrements sont affichés par ordre chronologique.</p>
      </div>
    </div>

    <!-- Interface Utilisateur -->
    <div id="userPanel" class="hidden">
      <div class="toolbar card">
        <div><strong>Espace Personnel</strong></div>
        <div><button onclick="logout()" class="secondary">Déconnexion</button></div>
      </div>

      <div class="card">
        <h3>Mes enregistrements</h3>
        <table id="tableUser">
          <thead>
            <tr>
              <th>ID</th><th>Nom principal</th><th>Document</th><th>Personnes</th>
              <th>Date</th><th>Status</th><th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button onclick="genererLien()" class="success">Générer le lien d'enregistrement invité</button>
        <p id="lienInvite" class="note"></p>
      </div>
    </div>

    <!-- Formulaire d'invité -->
    <div id="invitePanel" class="hidden">
      <div class="guest-form-container">
        <div class="toolbar">
          <h3 style="margin: 0; flex-grow: 1;">Enregistrement d'Invité</h3>
          <button onclick="retourAccueil()" class="secondary">Retour à l'accueil</button>
        </div>
        
        <form id="guestForm">
          <div class="row">
            <div class="col">
              <label>Appartement</label>
              <input type="text" id="invAppart" readonly class="guest-input" />
            </div>
            <div class="col">
              <label>Bâtiment</label>
              <input type="text" id="invBat" readonly class="guest-input" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Date d'arrivée</label>
              <input type="date" id="dateArrivee" required class="guest-input" />
            </div>
            <div class="col">
              <label>Nombre total de personnes</label>
              <input type="number" id="nbPers" min="1" value="1" required class="guest-input" onchange="genererChamps()" />
            </div>
          </div>

          <!-- Personne principale -->
          <div class="person-group">
            <h4>Personne principale</h4>
            <label>Nom & Prénom</label>
            <input type="text" id="nomPrincipal" required class="guest-input" placeholder="Nom complet de la personne principale" />
            
            <label>Passeport / CNI</label>
            <input type="text" id="docPrincipal" required class="guest-input" placeholder="Numéro de document d'identité" />
          </div>

          <div id="personnes"></div>

          <button type="submit" class="guest-button">Enregistrer les invités</button>
        </form>

        <div id="successMessage" class="success-message">
          ✅ Enregistrement réussi ! Les informations ont été sauvegardées.
        </div>

        <div id="qrcodeContainer" class="qrcode-container">
          <div class="qrcode-warning">
            ⚠️ IMPORTANT : Seules les personnes enregistrées dans ce formulaire seront autorisées à accéder à la résidence.
            Présentez ce QR code aux agents de sécurité à votre arrivée.
          </div>
          
          <div class="qrcode-header">Votre QR Code d'accès</div>
          <div id="qrcode" style="display: flex; justify-content: center; margin: 20px 0;"></div>
          <button id="downloadBtn" class="download-button">Télécharger le QR Code</button>
        </div>
      </div>
    </div>

    <div class="footer">
      Système d'Enregistrement des Invités &copy; 2023 - Tous droits réservés
    </div>
  </div>

  <script>
    /* =======================
       ÉTAT / CONSTANTES
    ======================== */
    let currentUser = null;
    const SESSION_TIMEOUT_MS = 15 * 60 * 1000; // 15 minutes
    let sessionTimer = null;
    let qrCode = null;
    
    // Structure des données stockées localement
    let appData = {
      users: [
        { user: 'admin', appart: 'admin', bat: 'admin', pass: 'admin' },
        { user: '66', appart: '6', bat: '6', pass: '15' }
      ],
      records: []
    };

    // Banner helpers
    function showBanner(type, text){
      const b = document.getElementById('banner');
      b.className = 'banner ' + type;
      b.textContent = text;
      b.classList.remove('hidden');
      setTimeout(hideBanner, 5000);
    }
    function hideBanner(){ 
      document.getElementById('banner').classList.add('hidden'); 
    }

    function showInlineMsg(elId, type, text){
      const el = document.getElementById(elId);
      el.textContent = text;
      el.className = 'banner ' + type;
      el.classList.remove('hidden');
    }
    function hideInlineMsg(elId){
      const el = document.getElementById(elId);
      el.classList.add('hidden');
    }

    /* =======================
       GESTION DES DONNÉES
    ======================== */
    // Sauvegarder les données dans localStorage
    function saveData() {
      localStorage.setItem('guestRegistrationData', JSON.stringify(appData));
    }
    
    // Charger les données depuis localStorage
    function loadData() {
      const savedData = localStorage.getItem('guestRegistrationData');
      if (savedData) {
        try {
          appData = JSON.parse(savedData);
          
          // Vérifier et ajouter les comptes par défaut si manquants
          if (!appData.users.some(u => u.user === 'admin')) {
            appData.users.push({ user: 'admin', appart: 'admin', bat: 'admin', pass: 'admin' });
          }
          
          if (!appData.users.some(u => u.user === '66')) {
            appData.users.push({ user: '66', appart: '6', bat: '6', pass: '15' });
          }
        } catch (e) {
          console.error("Erreur de chargement des données, réinitialisation...");
          saveData();
        }
      }
    }
    
    // Initialiser les données
    function initializeData() {
      loadData();
      document.getElementById('btnLogin').disabled = false;
      
      // Si lien invité présent, basculer en mode invité
      const params = new URLSearchParams(location.search);
      if(params.has("invite")) enterInviteMode(params.get("invite"));
    }

    /* =======================
       SESSION / SÉCURITÉ
    ======================== */
    function startSessionTimer(){
      stopSessionTimer();
      sessionTimer = setTimeout(()=>{
        logout(true);
        showBanner('warn', "Session expirée (inactivité). Veuillez vous reconnecter.");
      }, SESSION_TIMEOUT_MS);
    }
    function stopSessionTimer(){
      if(sessionTimer){ clearTimeout(sessionTimer); sessionTimer = null; }
    }
    function resetSessionTimer(){
      if(currentUser) startSessionTimer();
    }
    ['click','keydown','touchstart'].forEach(evt=>{
      document.addEventListener(evt, resetSessionTimer, {passive:true});
    });

    function logout(expired=false){
      currentUser = null;
      stopSessionTimer();
      // UI reset
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('userPanel').classList.add('hidden');
      document.getElementById('invitePanel').classList.add('hidden');
      document.getElementById('loginCard').classList.remove('hidden');
      if(!expired) showBanner('info', "Vous avez été déconnecté avec succès.");
    }

    function retourAccueil(){
      window.history.replaceState({}, document.title, location.pathname); // nettoie ?invite
      logout(false);
    }

    /* =======================
       AUTHENTIFICATION
    ======================== */
    function login(){
      hideInlineMsg('loginMsg');
      const u = document.getElementById('loginUser').value.trim();
      const p = document.getElementById('loginPass').value.trim();

      if(!u || !p){
        showInlineMsg('loginMsg','err',"Veuillez saisir l'utilisateur et le mot de passe.");
        return;
      }

      if(u === 'admin' && p === 'admin'){
        currentUser = { role:'admin' };
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        showBanner('ok', "Connecté en tant qu'administrateur.");
        startSessionTimer();
        refreshAdmin();
        return;
      }

      const user = appData.users.find(user => user.user === u && user.pass === p);
      if(user){
        currentUser = { role:'user', id:user.user, appart:user.appart, bat:user.bat };
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('userPanel').classList.remove('hidden');
        showBanner('ok', `Connecté. Appartement ${user.appart} / Immeuble ${user.bat}.`);
        startSessionTimer();
        refreshUser();
      } else {
        showInlineMsg('loginMsg','err',"Identifiants incorrects. Veuillez réessayer.");
      }
    }

    /* =======================
       ADMIN : UTILISATEURS
    ======================== */
    function creerUtilisateur(){
      hideInlineMsg('userWarn');
      const appart = (document.getElementById('appartAdmin').value || '').trim();
      const bat = (document.getElementById('batAdmin').value || '').trim();
      const pass = (document.getElementById('passAdmin').value || '').trim();
      
      if(!appart || !bat || !pass){
        showInlineMsg('userWarn','warn',"Tous les champs sont obligatoires.");
        return;
      }
      
      const userId = appart + bat;
      
      // Vérifier si l'utilisateur existe déjà
      const existingUser = appData.users.find(u => u.user === userId);
      if(existingUser){
        showInlineMsg('userWarn','warn',`L'utilisateur ${userId} existe déjà.`);
        return;
      }
      
      // Ajouter le nouvel utilisateur
      appData.users.push({ user: userId, appart, bat, pass });
      saveData();
      showBanner('ok', `Utilisateur ${userId} créé avec succès.`);
      refreshAdmin();
      
      // Réinitialiser les champs
      document.getElementById('appartAdmin').value = '';
      document.getElementById('batAdmin').value = '';
      document.getElementById('passAdmin').value = '';
    }

    function refreshAdmin(){
      // Liste utilisateurs
      const tbodyU = document.querySelector('#tableUsers tbody');
      tbodyU.innerHTML = '';
      appData.users.forEach(u => {
        tbodyU.insertAdjacentHTML('beforeend',
          `<tr>
            <td>${u.user}</td>
            <td>${u.appart}</td>
            <td>${u.bat}</td>
            <td>${u.pass}</td>
          </tr>`);
      });

      // Enregistrements
      const tbody = document.querySelector('#tableAdmin tbody');
      tbody.innerHTML = '';
      
      // Trier par date décroissante (les plus récents en premier)
      const sortedRecords = [...appData.records].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      sortedRecords.forEach(r => {
        const sendBtn = `<button onclick="envoyerWhatsApp(${r.id})">Envoyer</button>`;
        const deleteBtn = `<button onclick="supprimerEnregistrement(${r.id})" class="secondary" style="margin-top:5px;">Supprimer</button>`;
        
        tbody.insertAdjacentHTML('beforeend',
          `<tr>
            <td>${r.id}</td>
            <td>${r.appart}</td>
            <td>${r.bat}</td>
            <td>${r.nom}</td>
            <td>${r.doc}</td>
            <td>${r.personnes.length}</td>
            <td>${r.date}</td>
            <td>${sendBtn}${deleteBtn}</td>
            <td>${r.sent ? "Envoyé" : "Non envoyé"}</td>
          </tr>`);
      });
    }
    
    function supprimerEnregistrement(id) {
      if (confirm("Êtes-vous sûr de vouloir supprimer cet enregistrement ?")) {
        appData.records = appData.records.filter(r => r.id !== id);
        saveData();
        refreshAdmin();
        showBanner('ok', "Enregistrement supprimé avec succès.");
      }
    }

    /* =======================
       UTILISATEUR : MES ENREG.
    ======================== */
    function refreshUser(){
      const tbody = document.querySelector('#tableUser tbody');
      tbody.innerHTML = '';
      
      // Filtrer les enregistrements de l'utilisateur actuel
      const userRecords = appData.records.filter(r => 
        r.appart === currentUser.appart && r.bat === currentUser.bat
      );
      
      // Trier par date décroissante (les plus récents en premier)
      const sortedRecords = [...userRecords].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      sortedRecords.forEach(r => {
        const sendBtn = `<button onclick="envoyerWhatsApp(${r.id})">Envoyer</button>`;
        
        tbody.insertAdjacentHTML('beforeend',
          `<tr>
            <td>${r.id}</td>
            <td>${r.nom}</td>
            <td>${r.doc}</td>
            <td>${r.personnes.length}</td>
            <td>${r.date}</td>
            <td>${r.sent ? "Envoyé" : "Non envoyé"}</td>
            <td>${sendBtn}</td>
          </tr>`);
      });
    }

    function genererLien(){
      const base = location.href.split('?')[0];
      const lien = `${base}?invite=${encodeURIComponent(currentUser.id)}`;
      const p = document.getElementById('lienInvite');
      p.innerHTML = `Lien d'enregistrement pour vos invités : <a href="${lien}" target="_blank">${lien}</a>`;
      showBanner('info', "Copiez et partagez ce lien avec vos invités.");
    }

    /* =======================
       MODE INVITÉ
    ======================== */
    function enterInviteMode(userId){
      const user = appData.users.find(u => u.user === userId);
      if(!user){
        showBanner('err',"Lien invalide ou utilisateur introuvable.");
        return;
      }
      
      document.getElementById('loginCard').classList.add('hidden');
      document.getElementById('invitePanel').classList.remove('hidden');
      document.getElementById('invAppart').value = user.appart;
      document.getElementById('invBat').value = user.bat;
      genererChamps(); // init 1 personne
      hideBanner();
      
      // Initialiser QR Code Styling
      qrCode = new QRCodeStyling({
        width: 280,
        height: 280,
        margin: 10,
        qrOptions: { typeNumber: 0, mode: "Byte", errorCorrectionLevel: "H" },
        dotsOptions: { color: "#1E40AF", type: "rounded" },
        backgroundOptions: { color: "#FFFFFF" },
        cornersSquareOptions: { type: "extra-rounded", color: "#1E40AF" },
        cornersDotOptions: { type: "dot", color: "#1E40AF" },
        imageOptions: {
          hideBackgroundDots: true,
          imageSize: 0.4
        }
      });
      
      // Ajouter les gestionnaires d'événements
      document.getElementById('guestForm').addEventListener('submit', function(e) {
        e.preventDefault();
        enregistrer();
      });
      
      document.getElementById('downloadBtn').addEventListener('click', function() {
        if(qrCode) {
          qrCode.download({ name: "QR_Code_Invite", extension: "png" });
        }
      });
      
      // Définir la date d'aujourd'hui comme valeur par défaut
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateArrivee').value = today;
    }

    function genererChamps(){
      const nb = Math.max(1, parseInt(document.getElementById('nbPers').value || '1', 10));
      const cont = document.getElementById('personnes');
      cont.innerHTML = '';
      
      for(let i=2; i<=nb; i++){
        const group = document.createElement('div');
        group.className = 'person-group';
        
        const title = document.createElement('h4');
        title.textContent = `Personne ${i}`;
        group.appendChild(title);
        
        const nomLab = document.createElement('label');
        nomLab.textContent = 'Nom & Prénom';
        group.appendChild(nomLab);
        
        const nomInp = document.createElement('input');
        nomInp.type = 'text';
        nomInp.id = `pers${i}Nom`;
        nomInp.required = true;
        nomInp.className = 'guest-input';
        nomInp.placeholder = `Nom complet de la personne ${i}`;
        group.appendChild(nomInp);
        
        const docLab = document.createElement('label');
        docLab.textContent = 'Passeport / CNI';
        docLab.style.marginTop = '15px';
        group.appendChild(docLab);
        
        const docInp = document.createElement('input');
        docInp.type = 'text';
        docInp.id = `pers${i}Doc`;
        docInp.required = true;
        docInp.className = 'guest-input';
        docInp.placeholder = `Numéro de document d'identité`;
        group.appendChild(docInp);
        
        cont.appendChild(group);
      }
    }

    function buildMessage(rec){
      const nb = rec.personnes.length;
      const nomPrincipal = rec.nom;
      const docPrincipal = rec.doc;
      const autres = rec.personnes.map(p => `${p.nom} (${p.doc})`);
      const autresFR = autres.length ? autres.join(", ") : "Aucune autre personne";

      return `ENREGISTREMENT DES INVITÉS
--------------------------------
📍 Appartement: ${rec.appart}
🏢 Immeuble: ${rec.bat}
📅 Date d'arrivée: ${rec.date}
👥 Nombre de personnes: ${nb}

🧾 Réservation au nom de:
${nomPrincipal} (${docPrincipal})

👤 Autres personnes:
${autresFR}

⚠️ IMPORTANT: Seules les personnes enregistrées ici sont autorisées à accéder à la résidence.

Merci de présenter ce message aux agents de sécurité à votre arrivée.
------------------------------------------
تسجيل الضيوف
--------------------------------
📍 الشقة: ${rec.appart}
🏢 رقم العمارة: ${rec.bat}
📅 تاريخ الوصول: ${rec.date}
👥 عدد الأشخاص: ${nb}

🧾 الحجز باسم:
${nomPrincipal} (${docPrincipal})

👤 أشخاص آخرون:
${autresFR}

⚠️ ملاحظة: فقط الأشخاص المسجلين هنا مسموح لهم بالدخول.

يرجى تقديم هذه الرسالة لحراس الأمن عند الوصول.`;
    }

    function enregistrer(){
      // validations
      const nom = (document.getElementById('nomPrincipal').value || '').trim();
      const doc = (document.getElementById('docPrincipal').value || '').trim();
      const nb = parseInt(document.getElementById('nbPers').value || '0', 10);
      const date = document.getElementById('dateArrivee').value;

      if(!nom || !doc || !date || !Number.isInteger(nb) || nb < 1){
        showBanner('warn',"Tous les champs sont obligatoires, y compris le nombre total de personnes.");
        return;
      }

      const personnes = [];
      for(let i=2; i<=nb; i++){
        const nomVal = (document.getElementById(`pers${i}Nom`)?.value || '').trim();
        const docVal = (document.getElementById(`pers${i}Doc`)?.value || '').trim();
        
        if(!nomVal || !docVal){
          showBanner('warn',`Veuillez renseigner tous les champs pour la personne ${i}.`);
          return;
        }
        
        personnes.push({ nom: nomVal, doc: docVal });
      }

      const appart = document.getElementById('invAppart').value;
      const bat = document.getElementById('invBat').value;

      // Créer un ID unique basé sur le timestamp
      const id = Date.now();
      
      const rec = { 
        id,
        appart, 
        bat, 
        nom, 
        doc, 
        personnes, 
        date, 
        sent:false 
      };
      
      const msg = buildMessage(rec);

      // Ajouter l'enregistrement aux données
      appData.records.push(rec);
      saveData();
      
      // Afficher le message de succès et le QR code
      document.getElementById('successMessage').style.display = 'block';
      document.getElementById('qrcodeContainer').style.display = 'block';
      
      // Générer le QR Code
      if(qrCode) {
        qrCode.update({ data: msg });
        document.getElementById('qrcode').innerHTML = '';
        qrCode.append(document.getElementById('qrcode'));
      }

      // Masquer le formulaire
      document.getElementById('guestForm').style.display = 'none';
      
      // Afficher un message de succès
      showBanner('ok', "Enregistrement effectué avec succès !");
    }

    /* =======================
       ENVOI WHATSAPP
    ======================== */
    function envoyerWhatsApp(id){
      const rec = appData.records.find(r => r.id === id);
      if(!rec){
        showBanner('err',"Enregistrement introuvable.");
        return;
      }
      
      const msg = buildMessage(rec);
      const url = "https://wa.me/?text=" + encodeURIComponent(msg);
      window.open(url, "_blank");
      
      // Marquer comme envoyé
      rec.sent = true;
      saveData();
      
      if(currentUser.role === 'admin') {
        refreshAdmin();
      } else {
        refreshUser();
      }
      
      showBanner('ok', "Message WhatsApp généré avec succès.");
    }

    /* =======================
       DÉMARRAGE
    ======================== */
    // Initialisation des données et de l'interface
    document.addEventListener('DOMContentLoaded', () => {
      initializeData();
    });
  </script>
</body>
</html>